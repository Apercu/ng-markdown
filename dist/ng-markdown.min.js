var Markdown;Markdown="object"==typeof exports&&"function"==typeof require?exports:{},function(){function identity(x){return x}function returnFalse(){return!1}function HookCollection(){}function SaveHash(){}HookCollection.prototype={chain:function(hookname,func){var original=this[hookname];if(!original)throw new Error("unknown hook "+hookname);this[hookname]=original===identity?func:function(){var args=Array.prototype.slice.call(arguments,0);return args[0]=original.apply(null,args),func.apply(null,args)}},set:function(hookname,func){if(!this[hookname])throw new Error("unknown hook "+hookname);this[hookname]=func},addNoop:function(hookname){this[hookname]=identity},addFalse:function(hookname){this[hookname]=returnFalse}},Markdown.HookCollection=HookCollection,SaveHash.prototype={set:function(key,value){this["s_"+key]=value},get:function(key){return this["s_"+key]}},Markdown.Converter=function(){function _StripLinkDefinitions(text){return text=text.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?(?=\s|$)[ \t]*\n?[ \t]*((\n*)["(](.+?)[")][ \t]*)?(?:\n+)/gm,function(wholeMatch,m1,m2,m3,m4,m5){return m1=m1.toLowerCase(),g_urls.set(m1,_EncodeAmpsAndAngles(m2)),m4?m3:(m5&&g_titles.set(m1,m5.replace(/"/g,"&quot;")),"")})}function _HashHTMLBlocks(text){return text=text.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,hashElement),text=text.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)/gm,hashElement),text=text.replace(/\n[ ]{0,3}((<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,hashElement),text=text.replace(/\n\n[ ]{0,3}(<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>[ \t]*(?=\n{2,}))/g,hashElement),text=text.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,hashElement)}function hashElement(wholeMatch,m1){var blockText=m1;return blockText=blockText.replace(/^\n+/,""),blockText=blockText.replace(/\n+$/g,""),blockText="\n\n~K"+(g_html_blocks.push(blockText)-1)+"K\n\n"}function _RunBlockGamut(text,doNotUnhash){text=pluginHooks.preBlockGamut(text,blockGamutHookCallback),text=_DoHeaders(text);var replacement="<hr />\n";return text=text.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,replacement),text=text.replace(/^[ ]{0,2}([ ]?-[ ]?){3,}[ \t]*$/gm,replacement),text=text.replace(/^[ ]{0,2}([ ]?_[ ]?){3,}[ \t]*$/gm,replacement),text=_DoLists(text),text=_DoCodeBlocks(text),text=_DoBlockQuotes(text),text=pluginHooks.postBlockGamut(text,blockGamutHookCallback),text=_HashHTMLBlocks(text),text=_FormParagraphs(text,doNotUnhash)}function _RunSpanGamut(text){return text=pluginHooks.preSpanGamut(text),text=_DoCodeSpans(text),text=_EscapeSpecialCharsWithinTagAttributes(text),text=_EncodeBackslashEscapes(text),text=_DoImages(text),text=_DoAnchors(text),text=_DoAutoLinks(text),text=text.replace(/~P/g,"://"),text=_EncodeAmpsAndAngles(text),text=_DoItalicsAndBold(text),text=text.replace(/  +\n/g," <br>\n"),text=pluginHooks.postSpanGamut(text)}function _EscapeSpecialCharsWithinTagAttributes(text){var regex=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>)/gi;return text=text.replace(regex,function(wholeMatch){var tag=wholeMatch.replace(/(.)<\/?code>(?=.)/g,"$1`");return tag=escapeCharacters(tag,"!"==wholeMatch.charAt(1)?"\\`*_/":"\\`*_")})}function _DoAnchors(text){return text=text.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,writeAnchorTag),text=text.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?((?:\([^)]*\)|[^()\s])*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,writeAnchorTag),text=text.replace(/(\[([^\[\]]+)\])()()()()()/g,writeAnchorTag)}function writeAnchorTag(wholeMatch,m1,m2,m3,m4,m5,m6,m7){void 0===m7&&(m7="");var whole_match=m1,link_text=m2.replace(/:\/\//g,"~P"),link_id=m3.toLowerCase(),url=m4,title=m7;if(""===url)if(""===link_id&&(link_id=link_text.toLowerCase().replace(/ ?\n/g," ")),url="#"+link_id,void 0!==g_urls.get(link_id))url=g_urls.get(link_id),void 0!==g_titles.get(link_id)&&(title=g_titles.get(link_id));else{if(!(whole_match.search(/\(\s*\)$/m)>-1))return whole_match;url=""}url=encodeProblemUrlChars(url),url=escapeCharacters(url,"*_");var result='<a href="'+url+'"';return""!==title&&(title=attributeEncode(title),title=escapeCharacters(title,"*_"),result+=' title="'+title+'"'),result+=">"+link_text+"</a>"}function _DoImages(text){return text=text.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,writeImageTag),text=text.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,writeImageTag)}function attributeEncode(text){return text.replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}function writeImageTag(wholeMatch,m1,m2,m3,m4,m5,m6,m7){var whole_match=m1,alt_text=m2,link_id=m3.toLowerCase(),url=m4,title=m7;if(title||(title=""),""===url){if(""===link_id&&(link_id=alt_text.toLowerCase().replace(/ ?\n/g," ")),url="#"+link_id,void 0===g_urls.get(link_id))return whole_match;url=g_urls.get(link_id),void 0!==g_titles.get(link_id)&&(title=g_titles.get(link_id))}alt_text=escapeCharacters(attributeEncode(alt_text),"*_[]()"),url=escapeCharacters(url,"*_");var result='<img src="'+url+'" alt="'+alt_text+'"';return title=attributeEncode(title),title=escapeCharacters(title,"*_"),result+=' title="'+title+'"',result+=" />"}function _DoHeaders(text){return text=text.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(wholeMatch,m1){return"<h1>"+_RunSpanGamut(m1)+"</h1>\n\n"}),text=text.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(matchFound,m1){return"<h2>"+_RunSpanGamut(m1)+"</h2>\n\n"}),text=text.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(wholeMatch,m1,m2){var h_level=m1.length;return"<h"+h_level+">"+_RunSpanGamut(m2)+"</h"+h_level+">\n\n"})}function _DoLists(text,isInsideParagraphlessListItem){text+="~0";var whole_list=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;return g_list_level?text=text.replace(whole_list,function(wholeMatch,m1,m2){var list=m1,list_type=m2.search(/[*+-]/g)>-1?"ul":"ol",result=_ProcessListItems(list,list_type,isInsideParagraphlessListItem);return result=result.replace(/\s+$/,""),result="<"+list_type+">"+result+"</"+list_type+">\n"}):(whole_list=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g,text=text.replace(whole_list,function(wholeMatch,m1,m2,m3){var runup=m1,list=m2,list_type=m3.search(/[*+-]/g)>-1?"ul":"ol",result=_ProcessListItems(list,list_type);return result=runup+"<"+list_type+">\n"+result+"</"+list_type+">\n"})),text=text.replace(/~0/,"")}function _ProcessListItems(list_str,list_type,isInsideParagraphlessListItem){g_list_level++,list_str=list_str.replace(/\n{2,}$/,"\n"),list_str+="~0";var marker=_listItemMarkers[list_type],re=new RegExp("(^[ \\t]*)("+marker+")[ \\t]+([^\\r]+?(\\n+))(?=(~0|\\1("+marker+")[ \\t]+))","gm"),last_item_had_a_double_newline=!1;return list_str=list_str.replace(re,function(wholeMatch,m1,m2,m3){var item=m3,ends_with_double_newline=/\n\n$/.test(item),contains_double_newline=ends_with_double_newline||item.search(/\n{2,}/)>-1;return contains_double_newline||last_item_had_a_double_newline?item=_RunBlockGamut(_Outdent(item),!0):(item=_DoLists(_Outdent(item),!0),item=item.replace(/\n$/,""),isInsideParagraphlessListItem||(item=_RunSpanGamut(item))),last_item_had_a_double_newline=ends_with_double_newline,"<li>"+item+"</li>\n"}),list_str=list_str.replace(/~0/g,""),g_list_level--,list_str}function _DoCodeBlocks(text){return text+="~0",text=text.replace(/(?:\n\n|^\n?)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,function(wholeMatch,m1,m2){var codeblock=m1,nextChar=m2;return codeblock=_EncodeCode(_Outdent(codeblock)),codeblock=_Detab(codeblock),codeblock=codeblock.replace(/^\n+/g,""),codeblock=codeblock.replace(/\n+$/g,""),codeblock="<pre><code>"+codeblock+"\n</code></pre>","\n\n"+codeblock+"\n\n"+nextChar}),text=text.replace(/~0/,"")}function hashBlock(text){return text=text.replace(/(^\n+|\n+$)/g,""),"\n\n~K"+(g_html_blocks.push(text)-1)+"K\n\n"}function _DoCodeSpans(text){return text=text.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(wholeMatch,m1,m2,m3){var c=m3;return c=c.replace(/^([ \t]*)/g,""),c=c.replace(/[ \t]*$/g,""),c=_EncodeCode(c),c=c.replace(/:\/\//g,"~P"),m1+"<code>"+c+"</code>"})}function _EncodeCode(text){return text=text.replace(/&/g,"&amp;"),text=text.replace(/</g,"&lt;"),text=text.replace(/>/g,"&gt;"),text=escapeCharacters(text,"*_{}[]\\",!1)}function _DoItalicsAndBold(text){return text=text.replace(/([\W_]|^)(\*\*|__)(?=\S)([^\r]*?\S[\*_]*)\2([\W_]|$)/g,"$1<strong>$3</strong>$4"),text=text.replace(/([\W_]|^)(\*|_)(?=\S)([^\r\*_]*?\S)\2([\W_]|$)/g,"$1<em>$3</em>$4")}function _DoBlockQuotes(text){return text=text.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(wholeMatch,m1){var bq=m1;return bq=bq.replace(/^[ \t]*>[ \t]?/gm,"~0"),bq=bq.replace(/~0/g,""),bq=bq.replace(/^[ \t]+$/gm,""),bq=_RunBlockGamut(bq),bq=bq.replace(/(^|\n)/g,"$1  "),bq=bq.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(wholeMatch,m1){var pre=m1;return pre=pre.replace(/^  /gm,"~0"),pre=pre.replace(/~0/g,"")}),hashBlock("<blockquote>\n"+bq+"\n</blockquote>")})}function _FormParagraphs(text,doNotUnhash){text=text.replace(/^\n+/g,""),text=text.replace(/\n+$/g,"");for(var grafs=text.split(/\n{2,}/g),grafsOut=[],markerRe=/~K(\d+)K/,end=grafs.length,i=0;end>i;i++){var str=grafs[i];markerRe.test(str)?grafsOut.push(str):/\S/.test(str)&&(str=_RunSpanGamut(str),str=str.replace(/^([ \t]*)/g,"<p>"),str+="</p>",grafsOut.push(str))}if(!doNotUnhash)for(end=grafsOut.length,i=0;end>i;i++)for(var foundAny=!0;foundAny;)foundAny=!1,grafsOut[i]=grafsOut[i].replace(/~K(\d+)K/g,function(wholeMatch,id){return foundAny=!0,g_html_blocks[id]});return grafsOut.join("\n\n")}function _EncodeAmpsAndAngles(text){return text=text.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;"),text=text.replace(/<(?![a-z\/?!]|~D)/gi,"&lt;")}function _EncodeBackslashEscapes(text){return text=text.replace(/\\(\\)/g,escapeCharacters_callback),text=text.replace(/\\([`*_{}\[\]()>#+-.!])/g,escapeCharacters_callback)}function handleTrailingParens(wholeMatch,lookbehind,protocol,link){if(lookbehind)return wholeMatch;if(")"!==link.charAt(link.length-1))return"<"+protocol+link+">";for(var parens=link.match(/[()]/g),level=0,i=0;i<parens.length;i++)"("===parens[i]?0>=level?level=1:level++:level--;var tail="";if(0>level){var re=new RegExp("\\){1,"+-level+"}$");link=link.replace(re,function(trailingParens){return tail=trailingParens,""})}if(tail){var lastChar=link.charAt(link.length-1);endCharRegex.test(lastChar)||(tail=lastChar+tail,link=link.substr(0,link.length-1))}return"<"+protocol+link+">"+tail}function _DoAutoLinks(text){text=text.replace(autoLinkRegex,handleTrailingParens);var replacer=function(wholematch,m1){return'<a href="'+m1+'">'+pluginHooks.plainLinkText(m1)+"</a>"};return text=text.replace(/<((https?|ftp):[^'">\s]+)>/gi,replacer)}function _UnescapeSpecialChars(text){return text=text.replace(/~E(\d+)E/g,function(wholeMatch,m1){var charCodeToReplace=parseInt(m1);return String.fromCharCode(charCodeToReplace)})}function _Outdent(text){return text=text.replace(/^(\t|[ ]{1,4})/gm,"~0"),text=text.replace(/~0/g,"")}function _Detab(text){if(!/\t/.test(text))return text;var v,spaces=["    ","   ","  "," "],skew=0;return text.replace(/[\n\t]/g,function(match,offset){return"\n"===match?(skew=offset+1,match):(v=(offset-skew)%4,skew=offset+1,spaces[v])})}function encodeProblemUrlChars(url){if(!url)return"";var len=url.length;return url.replace(_problemUrlChars,function(match,offset){return"~D"==match?"%24":":"!=match||offset!=len-1&&!/[0-9\/]/.test(url.charAt(offset+1))?"%"+match.charCodeAt(0).toString(16):":"})}function escapeCharacters(text,charsToEscape,afterBackslash){var regexString="(["+charsToEscape.replace(/([\[\]\\])/g,"\\$1")+"])";afterBackslash&&(regexString="\\\\"+regexString);var regex=new RegExp(regexString,"g");return text=text.replace(regex,escapeCharacters_callback)}function escapeCharacters_callback(wholeMatch,m1){var charCodeToEscape=m1.charCodeAt(0);return"~E"+charCodeToEscape+"E"}var pluginHooks=this.hooks=new HookCollection;pluginHooks.addNoop("plainLinkText"),pluginHooks.addNoop("preConversion"),pluginHooks.addNoop("postNormalization"),pluginHooks.addNoop("preBlockGamut"),pluginHooks.addNoop("postBlockGamut"),pluginHooks.addNoop("preSpanGamut"),pluginHooks.addNoop("postSpanGamut"),pluginHooks.addNoop("postConversion");var g_urls,g_titles,g_html_blocks,g_list_level;this.makeHtml=function(text){if(g_urls)throw new Error("Recursive call to converter.makeHtml");return g_urls=new SaveHash,g_titles=new SaveHash,g_html_blocks=[],g_list_level=0,text=pluginHooks.preConversion(text),text=text.replace(/~/g,"~T"),text=text.replace(/\$/g,"~D"),text=text.replace(/\r\n/g,"\n"),text=text.replace(/\r/g,"\n"),text="\n\n"+text+"\n\n",text=_Detab(text),text=text.replace(/^[ \t]+$/gm,""),text=pluginHooks.postNormalization(text),text=_HashHTMLBlocks(text),text=_StripLinkDefinitions(text),text=_RunBlockGamut(text),text=_UnescapeSpecialChars(text),text=text.replace(/~D/g,"$$"),text=text.replace(/~T/g,"~"),text=pluginHooks.postConversion(text),g_html_blocks=g_titles=g_urls=null,text};var blockGamutHookCallback=function(t){return _RunBlockGamut(t)},_listItemMarkers={ol:"\\d+[.]",ul:"[*+-]"},charInsideUrl="[-A-Z0-9+&@#/%?=~_|[\\]()!:,.;]",charEndingUrl="[-A-Z0-9+&@#/%=~_|[\\])]",autoLinkRegex=new RegExp('(="|<)?\\b(https?|ftp)(://'+charInsideUrl+"*"+charEndingUrl+")(?=$|\\W)","gi"),endCharRegex=new RegExp(charEndingUrl,"i"),_problemUrlChars=/(?:["'*()[\]:]|~D)/g}}(),function(){function Chunks(){}function PanelCollection(postfix,prefix){this.buttonBar=doc.getElementsByClassName(prefix+"button-bar"+postfix)[0],this.preview=doc.getElementsByClassName(prefix+"preview"+postfix)[0],this.input=doc.getElementsByClassName(prefix+"input"+postfix)[0]}function UndoManager(callback,panels){var lastState,timer,inputStateObj,undoObj=this,undoStack=[],stackPtr=0,mode="none",setMode=function(newMode,noSave){mode!=newMode&&(mode=newMode,noSave||saveState()),uaSniffed.isIE&&"moving"==mode?inputStateObj=null:timer=setTimeout(refreshState,1)},refreshState=function(isInitialState){inputStateObj=new TextareaState(panels,isInitialState),timer=void 0};this.setCommandMode=function(){mode="command",saveState(),timer=setTimeout(refreshState,0)},this.canUndo=function(){return stackPtr>1},this.canRedo=function(){return undoStack[stackPtr+1]?!0:!1},this.undo=function(){undoObj.canUndo()&&(lastState?(lastState.restore(),lastState=null):(undoStack[stackPtr]=new TextareaState(panels),undoStack[--stackPtr].restore(),callback&&callback())),mode="none",panels.input.focus(),refreshState()},this.redo=function(){undoObj.canRedo()&&(undoStack[++stackPtr].restore(),callback&&callback()),mode="none",panels.input.focus(),refreshState()};var saveState=function(){var currState=inputStateObj||new TextareaState(panels);return currState?"moving"==mode?void(lastState||(lastState=currState)):(lastState&&(undoStack[stackPtr-1].text!=lastState.text&&(undoStack[stackPtr++]=lastState),lastState=null),undoStack[stackPtr++]=currState,undoStack[stackPtr+1]=null,void(callback&&callback())):!1},handleCtrlYZ=function(event){var handled=!1;if((event.ctrlKey||event.metaKey)&&!event.altKey){var keyCode=event.charCode||event.keyCode,keyCodeChar=String.fromCharCode(keyCode);switch(keyCodeChar.toLowerCase()){case"y":undoObj.redo(),handled=!0;break;case"z":event.shiftKey?undoObj.redo():undoObj.undo(),handled=!0}}return handled?(event.preventDefault&&event.preventDefault(),void(window.event&&(window.event.returnValue=!1))):void 0},handleModeChange=function(event){if(!event.ctrlKey&&!event.metaKey){var keyCode=event.keyCode;keyCode>=33&&40>=keyCode||keyCode>=63232&&63235>=keyCode?setMode("moving"):8==keyCode||46==keyCode||127==keyCode?setMode("deleting"):13==keyCode?setMode("newlines"):27==keyCode?setMode("escape"):(16>keyCode||keyCode>20)&&91!=keyCode&&setMode("typing")}},setEventHandlers=function(){util.addEvent(panels.input,"keypress",function(event){!event.ctrlKey&&!event.metaKey||event.altKey||89!=event.keyCode&&90!=event.keyCode||event.preventDefault()});var handlePaste=function(){(uaSniffed.isIE||inputStateObj&&inputStateObj.text!=panels.input.value)&&void 0===timer&&(mode="paste",saveState(),refreshState())};util.addEvent(panels.input,"keydown",handleCtrlYZ),util.addEvent(panels.input,"keydown",handleModeChange),util.addEvent(panels.input,"mousedown",function(){setMode("moving")}),panels.input.onpaste=handlePaste,panels.input.ondrop=handlePaste},init=function(){setEventHandlers(),refreshState(!0),saveState()};init()}function TextareaState(panels,isInitialState){var stateObj=this,inputArea=panels.input;this.init=function(){util.isVisible(inputArea)&&(isInitialState||!doc.activeElement||doc.activeElement===inputArea)&&(this.setInputAreaSelectionStartEnd(),this.scrollTop=inputArea.scrollTop,(!this.text&&inputArea.selectionStart||0===inputArea.selectionStart)&&(this.text=inputArea.value))},this.setInputAreaSelection=function(){if(util.isVisible(inputArea))if(void 0===inputArea.selectionStart||uaSniffed.isOpera){if(doc.selection){if(doc.activeElement&&doc.activeElement!==inputArea)return;inputArea.focus();var range=inputArea.createTextRange();range.moveStart("character",-inputArea.value.length),range.moveEnd("character",-inputArea.value.length),range.moveEnd("character",stateObj.end),range.moveStart("character",stateObj.start),range.select()}}else inputArea.focus(),inputArea.selectionStart=stateObj.start,inputArea.selectionEnd=stateObj.end,inputArea.scrollTop=stateObj.scrollTop},this.setInputAreaSelectionStartEnd=function(){if(panels.ieCachedRange||!inputArea.selectionStart&&0!==inputArea.selectionStart){if(doc.selection){stateObj.text=util.fixEolChars(inputArea.value);var range=panels.ieCachedRange||doc.selection.createRange(),fixedRange=util.fixEolChars(range.text),marker="",markedRange=marker+fixedRange+marker;range.text=markedRange;var inputText=util.fixEolChars(inputArea.value);range.moveStart("character",-markedRange.length),range.text=fixedRange,stateObj.start=inputText.indexOf(marker),stateObj.end=inputText.lastIndexOf(marker)-marker.length;var len=stateObj.text.length-util.fixEolChars(inputArea.value).length;if(len){for(range.moveStart("character",-fixedRange.length);len--;)fixedRange+="\n",stateObj.end+=1;range.text=fixedRange}panels.ieCachedRange&&(stateObj.scrollTop=panels.ieCachedScrollTop),panels.ieCachedRange=null,this.setInputAreaSelection()}}else stateObj.start=inputArea.selectionStart,stateObj.end=inputArea.selectionEnd},this.restore=function(){void 0!==stateObj.text&&stateObj.text!==inputArea.value&&(inputArea.value=stateObj.text),this.setInputAreaSelection(),inputArea.scrollTop=stateObj.scrollTop},this.getChunks=function(){var chunk=new Chunks;return chunk.before=util.fixEolChars(stateObj.text.substring(0,stateObj.start)),chunk.startTag="",chunk.selection=util.fixEolChars(stateObj.text.substring(stateObj.start,stateObj.end)),chunk.endTag="",chunk.after=util.fixEolChars(stateObj.text.substring(stateObj.end)),chunk.scrollTop=stateObj.scrollTop,chunk},this.setChunks=function(chunk){chunk.before=chunk.before+chunk.startTag,chunk.after=chunk.endTag+chunk.after,this.start=chunk.before.length,this.end=chunk.before.length+chunk.selection.length,this.text=chunk.before+chunk.selection+chunk.after,this.scrollTop=chunk.scrollTop},this.init()}function PreviewManager(converter,panels,previewRefreshCallback){var timeout,elapsedTime,oldInputText,maxDelay=3e3,startType="delayed",setupEvents=function(inputElem,listener){util.addEvent(inputElem,"input",listener),inputElem.onpaste=listener,inputElem.ondrop=listener,util.addEvent(inputElem,"keypress",listener),util.addEvent(inputElem,"keydown",listener)},getDocScrollTop=function(){var result=0;return window.innerHeight?result=window.pageYOffset:doc.documentElement&&doc.documentElement.scrollTop?result=doc.documentElement.scrollTop:doc.body&&(result=doc.body.scrollTop),result},makePreviewHtml=function(){if(panels.preview){var text=panels.input.value;if(!text||text!=oldInputText){oldInputText=text;var prevTime=(new Date).getTime();text=converter.makeHtml(text);var currTime=(new Date).getTime();elapsedTime=currTime-prevTime,pushPreviewHtml(text)}}},applyTimeout=function(){if(timeout&&(clearTimeout(timeout),timeout=void 0),"manual"!==startType){var delay=0;"delayed"===startType&&(delay=elapsedTime),delay>maxDelay&&(delay=maxDelay),timeout=setTimeout(makePreviewHtml,delay)}},getScaleFactor=function(panel){return panel.scrollHeight<=panel.clientHeight?1:panel.scrollTop/(panel.scrollHeight-panel.clientHeight)},setPanelScrollTops=function(){panels.preview&&(panels.preview.scrollTop=(panels.preview.scrollHeight-panels.preview.clientHeight)*getScaleFactor(panels.preview))};this.refresh=function(requiresRefresh){requiresRefresh?(oldInputText="",makePreviewHtml()):applyTimeout()},this.processingTime=function(){return elapsedTime};var previewSetter,isFirstTimeFilled=!0,ieSafePreviewSet=function(text){var preview=panels.preview,parent=preview.parentNode,sibling=preview.nextSibling;parent.removeChild(preview),preview.innerHTML=text,sibling?parent.insertBefore(preview,sibling):parent.appendChild(preview)},nonSuckyBrowserPreviewSet=function(text){panels.preview.innerHTML=text},previewSet=function(text){if(previewSetter)return previewSetter(text);try{nonSuckyBrowserPreviewSet(text),previewSetter=nonSuckyBrowserPreviewSet}catch(e){previewSetter=ieSafePreviewSet,previewSetter(text)}},pushPreviewHtml=function(text){var emptyTop=position.getTop(panels.input)-getDocScrollTop();if(panels.preview&&(previewSet(text),previewRefreshCallback()),setPanelScrollTops(),isFirstTimeFilled)return void(isFirstTimeFilled=!1);var fullTop=position.getTop(panels.input)-getDocScrollTop();uaSniffed.isIE?setTimeout(function(){window.scrollBy(0,fullTop-emptyTop)},0):window.scrollBy(0,fullTop-emptyTop)},init=function(){setupEvents(panels.input,applyTimeout),makePreviewHtml(),panels.preview&&(panels.preview.scrollTop=0)};init()}function UIManager(postfix,prefix,panels,undoManager,previewManager,commandManager,helpFunction,getString){function doClick(button){if(inputBox.focus(),button.textOp){undoManager&&undoManager.setCommandMode();var state=new TextareaState(panels);if(!state)return;var chunks=state.getChunks(),fixupInputArea=function(){inputBox.focus(),chunks&&state.setChunks(chunks),state.restore(),previewManager.refresh()},noCleanup=button.textOp(chunks,fixupInputArea);noCleanup||fixupInputArea()}button.execute&&button.execute(undoManager)}function setupButton(button,isEnabled){var normalYShift="0px",disabledYShift="-20px",highlightYShift="-40px",image=button.getElementsByTagName("span")[0];isEnabled?(image.style.backgroundPosition=button.XShift+" "+normalYShift,button.onmouseover=function(){image.style.backgroundPosition=this.XShift+" "+highlightYShift},button.onmouseout=function(){image.style.backgroundPosition=this.XShift+" "+normalYShift},uaSniffed.isIE&&(button.onmousedown=function(){doc.activeElement&&doc.activeElement!==panels.input||(panels.ieCachedRange=document.selection.createRange(),panels.ieCachedScrollTop=panels.input.scrollTop)}),button.isHelp||(button.onclick=function(){return this.onmouseout&&this.onmouseout(),doClick(this),!1})):(image.style.backgroundPosition=button.XShift+" "+disabledYShift,button.onmouseover=button.onmouseout=button.onclick=function(){})}function bindCommand(method){return"string"==typeof method&&(method=commandManager[method]),function(){method.apply(commandManager,arguments)}}function makeSpritedButtonRow(prefix){var buttonBar=panels.buttonBar,buttonRow=document.createElement("div");buttonRow.className="btn-toolbar "+prefix+"button-row"+postfix,buttonRow=buttonBar.appendChild(buttonRow);var makeButton=function(id,title,classname,textOp){var button=document.createElement("i");button.className=prefix+"button",button.className+=" "+classname;var buttonImage=document.createElement("span");return button.id=id+postfix,button.appendChild(buttonImage),button.title=title,textOp&&(button.textOp=textOp),setupButton(button,!0),buttonRow.appendChild(button),button},makeSpacer=function(){var spacer=document.createElement("i");spacer.className=prefix+"spacer",buttonRow.appendChild(spacer)};buttons.bold=makeButton(prefix+"bold-button",getString("bold"),"markdown-icon-bold",bindCommand("doBold")),buttons.italic=makeButton(prefix+"italic-button",getString("italic"),"markdown-icon-italic",bindCommand("doItalic")),makeSpacer(1),buttons.link=makeButton(prefix+"link-button",getString("link"),"markdown-icon-link",bindCommand(function(chunk,postProcessing){return this.doLinkOrImage(chunk,postProcessing,!1)})),buttons.quote=makeButton(prefix+"quote-button",getString("quote"),"markdown-icon-quotes-left",bindCommand("doBlockquote")),buttons.code=makeButton(prefix+"code-button",getString("code"),"markdown-icon-code",bindCommand("doCode")),buttons.image=makeButton(prefix+"image-button",getString("image"),"markdown-icon-image",bindCommand(function(chunk,postProcessing){return this.doLinkOrImage(chunk,postProcessing,!0)})),makeSpacer(2),buttons.olist=makeButton(prefix+"olist-button",getString("olist"),"markdown-icon-numbered-list",bindCommand(function(chunk,postProcessing){this.doList(chunk,postProcessing,!0)})),buttons.ulist=makeButton(prefix+"ulist-button",getString("ulist"),"markdown-icon-list",bindCommand(function(chunk,postProcessing){this.doList(chunk,postProcessing,!1)})),buttons.heading=makeButton(prefix+"heading-button",getString("heading"),"markdown-icon-font",bindCommand("doHeading")),buttons.hr=makeButton(prefix+"hr-button",getString("hr"),"markdown-icon-insert-template",bindCommand("doHorizontalRule")),makeSpacer(3),buttons.undo=makeButton(prefix+"undo-button",getString("undo"),"markdown-icon-undo",null),buttons.undo.execute=function(manager){manager&&manager.undo()};var redoTitle=getString(/win/.test(nav.platform.toLowerCase())?"redo":"redomac");if(buttons.redo=makeButton(prefix+"redo-button",redoTitle,"markdown-icon-redo",null),buttons.redo.execute=function(manager){manager&&manager.redo()},helpFunction){var helpButton=document.createElement("i"),helpButtonImage=document.createElement("span");helpButton.appendChild(helpButtonImage),helpButton.className=prefix+"button "+prefix+"help-button markdown-icon-question",helpButton.id=prefix+"help-button"+postfix,helpButton.isHelp=!0,helpButton.title=getString("help"),helpButton.onclick=helpFunction,setupButton(helpButton,!0),buttonRow.appendChild(helpButton),buttons.help=helpButton}setUndoRedoButtonStates()}function setUndoRedoButtonStates(){undoManager&&(setupButton(buttons.undo,undoManager.canUndo()),setupButton(buttons.redo,undoManager.canRedo()))}var inputBox=panels.input,buttons={};makeSpritedButtonRow(prefix);var keyEvent="keydown";uaSniffed.isOpera&&(keyEvent="keypress"),util.addEvent(inputBox,keyEvent,function(key){if((key.ctrlKey||key.metaKey)&&!key.altKey&&!key.shiftKey){var keyCode=key.charCode||key.keyCode,keyCodeStr=String.fromCharCode(keyCode).toLowerCase();switch(keyCodeStr){case"b":doClick(buttons.bold);break;case"i":doClick(buttons.italic);break;case"l":doClick(buttons.link);break;case"q":doClick(buttons.quote);break;case"k":doClick(buttons.code);break;case"g":doClick(buttons.image);break;case"o":doClick(buttons.olist);break;case"u":doClick(buttons.ulist);break;case"h":doClick(buttons.heading);break;case"r":doClick(buttons.hr);break;case"y":doClick(buttons.redo);break;case"z":doClick(key.shiftKey?buttons.redo:buttons.undo);break;default:return}key.preventDefault&&key.preventDefault(),window.event&&(window.event.returnValue=!1)}}),util.addEvent(inputBox,"keyup",function(key){if(key.shiftKey&&!key.ctrlKey&&!key.metaKey){var keyCode=key.charCode||key.keyCode;if(13===keyCode){var fakeButton={};fakeButton.textOp=bindCommand("doAutoindent"),doClick(fakeButton)}}}),uaSniffed.isIE&&util.addEvent(inputBox,"keydown",function(key){var code=key.keyCode;return 27===code?!1:void 0}),this.setUndoRedoButtonStates=setUndoRedoButtonStates}function CommandManager(pluginHooks,getString){this.hooks=pluginHooks,this.getString=getString}function properlyEncoded(linkdef){return linkdef.replace(/^\s*(.*?)(?:\s+"(.+)")?\s*$/,function(wholematch,link,title){return link=link.replace(/\?.*$/,function(querypart){return querypart.replace(/\+/g," ")}),link=decodeURIComponent(link),link=encodeURI(link).replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29"),link=link.replace(/\?.*$/,function(querypart){return querypart.replace(/\+/g,"%2b")}),title&&(title=title.trim?title.trim():title.replace(/^\s*/,"").replace(/\s*$/,""),title=title.replace(/"/g,"quot;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;").replace(/</g,"&lt;").replace(/>/g,"&gt;")),title?link+' "'+title+'"':link})}var prefixName,suffixName,util={},position={},ui={},doc=window.document,re=window.RegExp,nav=window.navigator,SETTINGS={lineLength:72},uaSniffed={isIE:/msie/.test(nav.userAgent.toLowerCase()),isIE_5or6:/msie 6/.test(nav.userAgent.toLowerCase())||/msie 5/.test(nav.userAgent.toLowerCase()),isOpera:/opera/.test(nav.userAgent.toLowerCase())},defaultsStrings={bold:"Strong <strong> Ctrl+B",boldexample:"strong text",italic:"Emphasis <em> Ctrl+I",italicexample:"emphasized text",link:"Hyperlink <a> Ctrl+L",linkdescription:"enter link description here",linkdialog:'<p><b>Insert Hyperlink</b></p><p>http://example.com/ "optional title"</p>',quote:"Blockquote <blockquote> Ctrl+Q",quoteexample:"Blockquote",code:"Code Sample <pre><code> Ctrl+K",codeexample:"enter code here",image:"Image <img> Ctrl+G",imagedescription:"enter image description here",imagedialog:'<p><b>Insert Image</b></p><p>http://example.com/images/diagram.jpg "optional title"</p>',olist:"Numbered List <ol> Ctrl+O",ulist:"Bulleted List <ul> Ctrl+U",litem:"List item",heading:"Heading <h1>/<h2> Ctrl+H",headingexample:"Heading",hr:"Horizontal Rule <hr> Ctrl+R",undo:"Undo - Ctrl+Z",redo:"Redo - Ctrl+Y",redomac:"Redo - Ctrl+Shift+Z",help:"Markdown Editing Help"},imageDefaultText="http://",linkDefaultText="http://";Markdown.Editor=function(markdownConverter,idPostfix,idPrefix,helpFunction,strings){strings=strings||{};var getString=function(identifier){return strings[identifier]||defaultsStrings[identifier]};idPostfix=idPostfix||"",suffixName=idPostfix,prefixName=idPrefix;var hooks=this.hooks=new Markdown.HookCollection;hooks.addNoop("onPreviewRefresh"),hooks.addNoop("postBlockquoteCreation"),hooks.addFalse("insertImageDialog"),this.getConverter=function(){return markdownConverter};var panels,that=this;this.run=function(){if(!panels){panels=new PanelCollection(idPostfix,idPrefix);var undoManager,uiManager,commandManager=new CommandManager(hooks,getString),previewManager=new PreviewManager(markdownConverter,panels,function(){hooks.onPreviewRefresh()});/\?noundo/.test(doc.location.href)||(undoManager=new UndoManager(function(){previewManager.refresh(),uiManager&&uiManager.setUndoRedoButtonStates()},panels),this.textOperation=function(f){undoManager.setCommandMode(),f(),that.refreshPreview()}),uiManager=new UIManager(idPostfix,idPrefix,panels,undoManager,previewManager,commandManager,helpFunction,getString),uiManager.setUndoRedoButtonStates();var forceRefresh=that.refreshPreview=function(){previewManager.refresh(!0)};forceRefresh()}}},Chunks.prototype.findTags=function(startRegex,endRegex){var regex,chunkObj=this;startRegex&&(regex=util.extendRegExp(startRegex,"","$"),this.before=this.before.replace(regex,function(match){return chunkObj.startTag=chunkObj.startTag+match,""}),regex=util.extendRegExp(startRegex,"^",""),this.selection=this.selection.replace(regex,function(match){return chunkObj.startTag=chunkObj.startTag+match,""})),endRegex&&(regex=util.extendRegExp(endRegex,"","$"),this.selection=this.selection.replace(regex,function(match){return chunkObj.endTag=match+chunkObj.endTag,""}),regex=util.extendRegExp(endRegex,"^",""),this.after=this.after.replace(regex,function(match){return chunkObj.endTag=match+chunkObj.endTag,""
}))},Chunks.prototype.trimWhitespace=function(remove){var beforeReplacer,afterReplacer,that=this;remove?beforeReplacer=afterReplacer="":(beforeReplacer=function(s){return that.before+=s,""},afterReplacer=function(s){return that.after=s+that.after,""}),this.selection=this.selection.replace(/^(\s*)/,beforeReplacer).replace(/(\s*)$/,afterReplacer)},Chunks.prototype.skipLines=function(nLinesBefore,nLinesAfter,findExtraNewlines){void 0===nLinesBefore&&(nLinesBefore=1),void 0===nLinesAfter&&(nLinesAfter=1),nLinesBefore++,nLinesAfter++;var regexText,replacementText;if(navigator.userAgent.match(/Chrome/)&&"X".match(/()./),this.selection=this.selection.replace(/(^\n*)/,""),this.startTag=this.startTag+re.$1,this.selection=this.selection.replace(/(\n*$)/,""),this.endTag=this.endTag+re.$1,this.startTag=this.startTag.replace(/(^\n*)/,""),this.before=this.before+re.$1,this.endTag=this.endTag.replace(/(\n*$)/,""),this.after=this.after+re.$1,this.before){for(regexText=replacementText="";nLinesBefore--;)regexText+="\\n?",replacementText+="\n";findExtraNewlines&&(regexText="\\n*"),this.before=this.before.replace(new re(regexText+"$",""),replacementText)}if(this.after){for(regexText=replacementText="";nLinesAfter--;)regexText+="\\n?",replacementText+="\n";findExtraNewlines&&(regexText="\\n*"),this.after=this.after.replace(new re(regexText,""),replacementText)}},util.isVisible=function(elem){return window.getComputedStyle?"none"!==window.getComputedStyle(elem,null).getPropertyValue("display"):elem.currentStyle?"none"!==elem.currentStyle.display:void 0},util.addEvent=function(elem,event,listener){elem.attachEvent?elem.attachEvent("on"+event,listener):elem.addEventListener(event,listener,!1)},util.removeEvent=function(elem,event,listener){elem.detachEvent?elem.detachEvent("on"+event,listener):elem.removeEventListener(event,listener,!1)},util.fixEolChars=function(text){return text=text.replace(/\r\n/g,"\n"),text=text.replace(/\r/g,"\n")},util.extendRegExp=function(regex,pre,post){(null===pre||void 0===pre)&&(pre=""),(null===post||void 0===post)&&(post="");var flags,pattern=regex.toString();return pattern=pattern.replace(/\/([gim]*)$/,function(wholeMatch,flagsPart){return flags=flagsPart,""}),pattern=pattern.replace(/(^\/|\/$)/g,""),pattern=pre+pattern+post,new re(pattern,flags)},position.getTop=function(elem,isInner){var result=elem.offsetTop;if(!isInner)for(;elem=elem.offsetParent;)result+=elem.offsetTop;return result},position.getHeight=function(elem){return elem.offsetHeight||elem.scrollHeight},position.getWidth=function(elem){return elem.offsetWidth||elem.scrollWidth},position.getPageSize=function(){var scrollWidth,scrollHeight,innerWidth,innerHeight;self.innerHeight&&self.scrollMaxY?(scrollWidth=doc.body.scrollWidth,scrollHeight=self.innerHeight+self.scrollMaxY):doc.body.scrollHeight>doc.body.offsetHeight?(scrollWidth=doc.body.scrollWidth,scrollHeight=doc.body.scrollHeight):(scrollWidth=doc.body.offsetWidth,scrollHeight=doc.body.offsetHeight),self.innerHeight?(innerWidth=self.innerWidth,innerHeight=self.innerHeight):doc.documentElement&&doc.documentElement.clientHeight?(innerWidth=doc.documentElement.clientWidth,innerHeight=doc.documentElement.clientHeight):doc.body&&(innerWidth=doc.body.clientWidth,innerHeight=doc.body.clientHeight);var maxWidth=Math.max(scrollWidth,innerWidth),maxHeight=Math.max(scrollHeight,innerHeight);return[maxWidth,maxHeight,innerWidth,innerHeight]},ui.createBackground=function(){var background=doc.createElement("div"),style=background.style;background.className=prefixName+"prompt-background"+suffixName,uaSniffed.isIE&&(style.filter="alpha(opacity=50)");position.getPageSize();return uaSniffed.isIE&&(style.left=doc.documentElement.scrollLeft,style.width=doc.documentElement.clientWidth),doc.body.appendChild(background),background},ui.prompt=function(text,defaultInputText,callback){var dialog,input;void 0===defaultInputText&&(defaultInputText="");var checkEscape=function(key){var code=key.charCode||key.keyCode;27===code&&close(!0)},close=function(isCancel){util.removeEvent(doc.body,"keydown",checkEscape);var text=input.value;return isCancel?text=null:(text=text.replace(/^http:\/\/(https?|ftp):\/\//,"$1://"),/^(?:https?|ftp):\/\//.test(text)||(text="http://"+text)),dialog.parentNode.removeChild(dialog),callback(text),!1},createDialog=function(){dialog=doc.createElement("div"),dialog.className=prefixName+"prompt-dialog"+suffixName;var question=doc.createElement("div");question.innerHTML=text,dialog.appendChild(question);var form=doc.createElement("form");form.onsubmit=function(){return close(!1)},dialog.appendChild(form),input=doc.createElement("input"),input.type="text",input.value=defaultInputText,form.appendChild(input);var okButton=doc.createElement("input");okButton.type="button",okButton.onclick=function(){return close(!1)},okButton.value="OK";var cancelButton=doc.createElement("input");cancelButton.type="button",cancelButton.onclick=function(){return close(!0)},cancelButton.value="Cancel",form.appendChild(okButton),form.appendChild(cancelButton),util.addEvent(doc.body,"keydown",checkEscape),uaSniffed.isIE_5or6&&(dialog.style.position="absolute",dialog.style.top=doc.documentElement.scrollTop+200+"px",dialog.style.left="50%",dialog.style.marginTop=-(position.getHeight(dialog)/2)+"px",dialog.style.marginLeft=-(position.getWidth(dialog)/2)+"px"),doc.body.appendChild(dialog)};setTimeout(function(){createDialog();var defTextLen=defaultInputText.length;if(void 0!==input.selectionStart)input.selectionStart=0,input.selectionEnd=defTextLen;else if(input.createTextRange){var range=input.createTextRange();range.collapse(!1),range.moveStart("character",-defTextLen),range.moveEnd("character",defTextLen),range.select()}input.focus()},0)};var commandProto=CommandManager.prototype;commandProto.prefixes="(?:\\s{4,}|\\s*>|\\s*-\\s+|\\s*\\d+\\.|=|\\+|-|_|\\*|#|\\s*\\[[^\n]]+\\]:)",commandProto.unwrap=function(chunk){var txt=new re("([^\\n])\\n(?!(\\n|"+this.prefixes+"))","g");chunk.selection=chunk.selection.replace(txt,"$1 $2")},commandProto.wrap=function(chunk,len){this.unwrap(chunk);var regex=new re("(.{1,"+len+"})( +|$\\n?)","gm"),that=this;chunk.selection=chunk.selection.replace(regex,function(line,marked){return new re("^"+that.prefixes,"").test(line)?line:marked+"\n"}),chunk.selection=chunk.selection.replace(/\s+$/,"")},commandProto.doBold=function(chunk,postProcessing){return this.doBorI(chunk,postProcessing,2,this.getString("boldexample"))},commandProto.doItalic=function(chunk,postProcessing){return this.doBorI(chunk,postProcessing,1,this.getString("italicexample"))},commandProto.doBorI=function(chunk,postProcessing,nStars,insertText){chunk.trimWhitespace(),chunk.selection=chunk.selection.replace(/\n{2,}/g,"\n");var starsBefore=/(\**$)/.exec(chunk.before)[0],starsAfter=/(^\**)/.exec(chunk.after)[0],prevStars=Math.min(starsBefore.length,starsAfter.length);if(prevStars>=nStars&&(2!=prevStars||1!=nStars))chunk.before=chunk.before.replace(re("[*]{"+nStars+"}$",""),""),chunk.after=chunk.after.replace(re("^[*]{"+nStars+"}",""),"");else if(!chunk.selection&&starsAfter){chunk.after=chunk.after.replace(/^([*_]*)/,""),chunk.before=chunk.before.replace(/(\s?)$/,"");var whitespace=re.$1;chunk.before=chunk.before+starsAfter+whitespace}else{chunk.selection||starsAfter||(chunk.selection=insertText);var markup=1>=nStars?"*":"**";chunk.before=chunk.before+markup,chunk.after=markup+chunk.after}},commandProto.stripLinkDefs=function(text,defsToAdd){return text=text.replace(/^[ ]{0,3}\[(\d+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|$)/gm,function(totalMatch,id,link,newlines,title){return defsToAdd[id]=totalMatch.replace(/\s*$/,""),newlines?(defsToAdd[id]=totalMatch.replace(/["(](.+?)[")]$/,""),newlines+title):""})},commandProto.addLinkDef=function(chunk,linkDef){var refNumber=0,defsToAdd={};chunk.before=this.stripLinkDefs(chunk.before,defsToAdd),chunk.selection=this.stripLinkDefs(chunk.selection,defsToAdd),chunk.after=this.stripLinkDefs(chunk.after,defsToAdd);var defs="",regex=/(\[)((?:\[[^\]]*\]|[^\[\]])*)(\][ ]?(?:\n[ ]*)?\[)(\d+)(\])/g,addDefNumber=function(def){refNumber++,def=def.replace(/^[ ]{0,3}\[(\d+)\]:/,"  ["+refNumber+"]:"),defs+="\n"+def},getLink=function(wholeMatch,before,inner,afterInner,id,end){return inner=inner.replace(regex,getLink),defsToAdd[id]?(addDefNumber(defsToAdd[id]),before+inner+afterInner+refNumber+end):wholeMatch};chunk.before=chunk.before.replace(regex,getLink),linkDef?addDefNumber(linkDef):chunk.selection=chunk.selection.replace(regex,getLink);var refOut=refNumber;return chunk.after=chunk.after.replace(regex,getLink),chunk.after&&(chunk.after=chunk.after.replace(/\n*$/,"")),chunk.after||(chunk.selection=chunk.selection.replace(/\n*$/,"")),chunk.after+="\n\n"+defs,refOut},commandProto.doLinkOrImage=function(chunk,postProcessing,isImage){chunk.trimWhitespace(),chunk.findTags(/\s*!?\[/,/\][ ]?(?:\n[ ]*)?(\[.*?\])?/);var background;if(!(chunk.endTag.length>1&&chunk.startTag.length>0)){if(chunk.selection=chunk.startTag+chunk.selection+chunk.endTag,chunk.startTag=chunk.endTag="",/\n\n/.test(chunk.selection))return void this.addLinkDef(chunk,null);var that=this,linkEnteredCallback=function(link){if(background.parentNode.removeChild(background),null!==link){chunk.selection=(" "+chunk.selection).replace(/([^\\](?:\\\\)*)(?=[[\]])/g,"$1\\").substr(1);var linkDef=" [999]: "+properlyEncoded(link),num=that.addLinkDef(chunk,linkDef);chunk.startTag=isImage?"![":"[",chunk.endTag="]["+num+"]",chunk.selection||(chunk.selection=that.getString(isImage?"imagedescription":"linkdescription"))}postProcessing()};return background=ui.createBackground(),isImage?this.hooks.insertImageDialog(linkEnteredCallback)||ui.prompt(this.getString("imagedialog"),imageDefaultText,linkEnteredCallback):ui.prompt(this.getString("linkdialog"),linkDefaultText,linkEnteredCallback),!0}chunk.startTag=chunk.startTag.replace(/!?\[/,""),chunk.endTag="",this.addLinkDef(chunk,null)},commandProto.doAutoindent=function(chunk){var commandMgr=this,fakeSelection=!1;chunk.before=chunk.before.replace(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]*\n$/,"\n\n"),chunk.before=chunk.before.replace(/(\n|^)[ ]{0,3}>[ \t]*\n$/,"\n\n"),chunk.before=chunk.before.replace(/(\n|^)[ \t]+\n$/,"\n\n"),chunk.selection||/^[ \t]*(?:\n|$)/.test(chunk.after)||(chunk.after=chunk.after.replace(/^[^\n]*/,function(wholeMatch){return chunk.selection=wholeMatch,""}),fakeSelection=!0),/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]+.*\n$/.test(chunk.before)&&commandMgr.doList&&commandMgr.doList(chunk),/(\n|^)[ ]{0,3}>[ \t]+.*\n$/.test(chunk.before)&&commandMgr.doBlockquote&&commandMgr.doBlockquote(chunk),/(\n|^)(\t|[ ]{4,}).*\n$/.test(chunk.before)&&commandMgr.doCode&&commandMgr.doCode(chunk),fakeSelection&&(chunk.after=chunk.selection+chunk.after,chunk.selection="")},commandProto.doBlockquote=function(chunk){chunk.selection=chunk.selection.replace(/^(\n*)([^\r]+?)(\n*)$/,function(totalMatch,newlinesBefore,text,newlinesAfter){return chunk.before+=newlinesBefore,chunk.after=newlinesAfter+chunk.after,text}),chunk.before=chunk.before.replace(/(>[ \t]*)$/,function(totalMatch,blankLine){return chunk.selection=blankLine+chunk.selection,""}),chunk.selection=chunk.selection.replace(/^(\s|>)+$/,""),chunk.selection=chunk.selection||this.getString("quoteexample");var line,match="",leftOver="";if(chunk.before){for(var lines=chunk.before.replace(/\n$/,"").split("\n"),inChain=!1,i=0;i<lines.length;i++){var good=!1;line=lines[i],inChain=inChain&&line.length>0,/^>/.test(line)?(good=!0,!inChain&&line.length>1&&(inChain=!0)):good=/^[ \t]*$/.test(line)?!0:inChain,good?match+=line+"\n":(leftOver+=match+line,match="\n")}/(^|\n)>/.test(match)||(leftOver+=match,match="")}chunk.startTag=match,chunk.before=leftOver,chunk.after&&(chunk.after=chunk.after.replace(/^\n?/,"\n")),chunk.after=chunk.after.replace(/^(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*)/,function(totalMatch){return chunk.endTag=totalMatch,""});var replaceBlanksInTags=function(useBracket){var replacement=useBracket?"> ":"";chunk.startTag&&(chunk.startTag=chunk.startTag.replace(/\n((>|\s)*)\n$/,function(totalMatch,markdown){return"\n"+markdown.replace(/^[ ]{0,3}>?[ \t]*$/gm,replacement)+"\n"})),chunk.endTag&&(chunk.endTag=chunk.endTag.replace(/^\n((>|\s)*)\n/,function(totalMatch,markdown){return"\n"+markdown.replace(/^[ ]{0,3}>?[ \t]*$/gm,replacement)+"\n"}))};/^(?![ ]{0,3}>)/m.test(chunk.selection)?(this.wrap(chunk,SETTINGS.lineLength-2),chunk.selection=chunk.selection.replace(/^/gm,"> "),replaceBlanksInTags(!0),chunk.skipLines()):(chunk.selection=chunk.selection.replace(/^[ ]{0,3}> ?/gm,""),this.unwrap(chunk),replaceBlanksInTags(!1),!/^(\n|^)[ ]{0,3}>/.test(chunk.selection)&&chunk.startTag&&(chunk.startTag=chunk.startTag.replace(/\n{0,2}$/,"\n\n")),!/(\n|^)[ ]{0,3}>.*$/.test(chunk.selection)&&chunk.endTag&&(chunk.endTag=chunk.endTag.replace(/^\n{0,2}/,"\n\n"))),chunk.selection=this.hooks.postBlockquoteCreation(chunk.selection),/\n/.test(chunk.selection)||(chunk.selection=chunk.selection.replace(/^(> *)/,function(wholeMatch,blanks){return chunk.startTag+=blanks,""}))},commandProto.doCode=function(chunk){var hasTextBefore=/\S[ ]*$/.test(chunk.before),hasTextAfter=/^[ ]*\S/.test(chunk.after);if(!hasTextAfter&&!hasTextBefore||/\n/.test(chunk.selection)){chunk.before=chunk.before.replace(/[ ]{4}$/,function(totalMatch){return chunk.selection=totalMatch+chunk.selection,""});var nLinesBack=1,nLinesForward=1;/(\n|^)(\t|[ ]{4,}).*\n$/.test(chunk.before)&&(nLinesBack=0),/^\n(\t|[ ]{4,})/.test(chunk.after)&&(nLinesForward=0),chunk.skipLines(nLinesBack,nLinesForward),chunk.selection?/^[ ]{0,3}\S/m.test(chunk.selection)?/\n/.test(chunk.selection)?chunk.selection=chunk.selection.replace(/^/gm,"    "):chunk.before+="    ":chunk.selection=chunk.selection.replace(/^(?:[ ]{4}|[ ]{0,3}\t)/gm,""):(chunk.startTag="    ",chunk.selection=this.getString("codeexample"))}else chunk.trimWhitespace(),chunk.findTags(/`/,/`/),chunk.startTag||chunk.endTag?chunk.endTag&&!chunk.startTag?(chunk.before+=chunk.endTag,chunk.endTag=""):chunk.startTag=chunk.endTag="":(chunk.startTag=chunk.endTag="`",chunk.selection||(chunk.selection=this.getString("codeexample")))},commandProto.doList=function(chunk,postProcessing,isNumberedList){var previousItemsRegex=/(\n|^)(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*$/,nextItemsRegex=/^\n*(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*/,bullet="-",num=1,getItemPrefix=function(){var prefix;return isNumberedList?(prefix=" "+num+". ",num++):prefix=" "+bullet+" ",prefix},getPrefixedItem=function(itemText){return void 0===isNumberedList&&(isNumberedList=/^\s*\d/.test(itemText)),itemText=itemText.replace(/^[ ]{0,3}([*+-]|\d+[.])\s/gm,function(){return getItemPrefix()})};if(chunk.findTags(/(\n|^)*[ ]{0,3}([*+-]|\d+[.])\s+/,null),!chunk.before||/\n$/.test(chunk.before)||/^\n/.test(chunk.startTag)||(chunk.before+=chunk.startTag,chunk.startTag=""),chunk.startTag){var hasDigits=/\d+[.]/.test(chunk.startTag);if(chunk.startTag="",chunk.selection=chunk.selection.replace(/\n[ ]{4}/g,"\n"),this.unwrap(chunk),chunk.skipLines(),hasDigits&&(chunk.after=chunk.after.replace(nextItemsRegex,getPrefixedItem)),isNumberedList==hasDigits)return}var nLinesUp=1;chunk.before=chunk.before.replace(previousItemsRegex,function(itemText){return/^\s*([*+-])/.test(itemText)&&(bullet=re.$1),nLinesUp=/[^\n]\n\n[^\n]/.test(itemText)?1:0,getPrefixedItem(itemText)}),chunk.selection||(chunk.selection=this.getString("litem"));var prefix=getItemPrefix(),nLinesDown=1;chunk.after=chunk.after.replace(nextItemsRegex,function(itemText){return nLinesDown=/[^\n]\n\n[^\n]/.test(itemText)?1:0,getPrefixedItem(itemText)}),chunk.trimWhitespace(!0),chunk.skipLines(nLinesUp,nLinesDown,!0),chunk.startTag=prefix;var spaces=prefix.replace(/./g," ");this.wrap(chunk,SETTINGS.lineLength-spaces.length),chunk.selection=chunk.selection.replace(/\n/g,"\n"+spaces)},commandProto.doHeading=function(chunk){if(chunk.selection=chunk.selection.replace(/\s+/g," "),chunk.selection=chunk.selection.replace(/(^\s+|\s+$)/g,""),!chunk.selection)return chunk.startTag="## ",chunk.selection=this.getString("headingexample"),void(chunk.endTag=" ##");var headerLevel=0;chunk.findTags(/#+[ ]*/,/[ ]*#+/),/#+/.test(chunk.startTag)&&(headerLevel=re.lastMatch.length),chunk.startTag=chunk.endTag="",chunk.findTags(null,/\s?(-+|=+)/),/=+/.test(chunk.endTag)&&(headerLevel=1),/-+/.test(chunk.endTag)&&(headerLevel=2),chunk.startTag=chunk.endTag="",chunk.skipLines(1,1);var headerLevelToCreate=0===headerLevel?2:headerLevel-1;if(headerLevelToCreate>0){var headerChar=headerLevelToCreate>=2?"-":"=",len=chunk.selection.length;for(len>SETTINGS.lineLength&&(len=SETTINGS.lineLength),chunk.endTag="\n";len--;)chunk.endTag+=headerChar}},commandProto.doHorizontalRule=function(chunk){chunk.startTag="----------\n",chunk.selection="",chunk.skipLines(2,1,!0)}}(),function(){function sanitizeHtml(html){return html.replace(/<[^>]*>?/gi,sanitizeTag)}function sanitizeTag(tag){return tag.match(basic_tag_whitelist)||tag.match(a_white)||tag.match(img_white)?tag:""}function balanceTags(html){if(""===html)return"";var re=/<\/?\w+[^>]*(\s|$|>)/g,tags=html.toLowerCase().match(re),tagcount=(tags||[]).length;if(0===tagcount)return html;for(var tagname,tag,match,ignoredtags="<p><img><br><li><hr>",tagpaired=[],tagremove=[],needsRemoval=!1,ctag=0;tagcount>ctag;ctag++)if(tagname=tags[ctag].replace(/<\/?(\w+).*/,"$1"),!(tagpaired[ctag]||ignoredtags.search("<"+tagname+">")>-1)){if(tag=tags[ctag],match=-1,!/^<\//.test(tag))for(var ntag=ctag+1;tagcount>ntag;ntag++)if(!tagpaired[ntag]&&tags[ntag]=="</"+tagname+">"){match=ntag;break}-1==match?needsRemoval=tagremove[ctag]=!0:tagpaired[match]=!0}return needsRemoval?(ctag=0,html=html.replace(re,function(match){var res=tagremove[ctag]?"":match;return ctag++,res})):html}var output,Converter;"object"==typeof exports&&"function"==typeof require?(output=exports,Converter=require("./Markdown.Converter").Converter):(output=window.Markdown,Converter=output.Converter),output.getSanitizingConverter=function(){var converter=new Converter;return converter.hooks.chain("postConversion",sanitizeHtml),converter.hooks.chain("postConversion",balanceTags),converter};var basic_tag_whitelist=/^(<\/?(b|blockquote|code|del|dd|dl|dt|em|h1|h2|h3|i|kbd|li|ol|p|pre|s|sup|sub|strong|strike|ul)>|<(br|hr)\s?\/?>)$/i,a_white=/^(<a\shref="((https?|ftp):\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\stitle="[^"<>]+")?\s?>|<\/a>)$/i,img_white=/^(<img\ssrc="(https?:\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\swidth="\d{1,3}")?(\sheight="\d{1,3}")?(\salt="[^"<>]*")?(\stitle="[^"<>]*")?\s?\/?>)$/i}(),function(){"use strict";angular.module("ngMarkdown",["monospaced.elastic"]).config(["msdElasticConfig",function(config){config.append="\n\n"}]).directive("ngMarkdown",function($timeout){return{template:"<textarea msd-elastic></textarea>",restrict:"EA",replace:!0,scope:{preConversion:"=",postConversion:"=",postNormalization:"=",plainLinkText:"=",preBlockGamut:"=",postBlockGamut:"=",preSpanGamut:"=",postSpanGamut:"=",onPreviewRefresh:"=",helpHandler:"=",customStrings:"=",ngModel:"="},compile:function(){return{post:function(scope,element,attrs){var editor,converter=Markdown.getSanitizingConverter(),postfix="",prefix="wmd-",helpHandler=null,strings={};"false"===attrs.sanitized&&(converter=new Markdown.Converter),attrs.suffix&&(postfix=attrs.suffix),attrs.prefix&&(prefix=attrs.prefix),attrs.preConversion&&converter.hooks.chain("preConversion",scope.preConversion),attrs.postConversion&&converter.hooks.chain("postConversion",scope.postConversion),attrs.postNormalization&&converter.hooks.chain("postNormalization",scope.postNormalization),attrs.plainLinkText&&converter.hooks.chain("plainLinkText",scope.plainLinkText),attrs.preBlockGamut&&converter.hooks.chain("preBlockGamut",scope.preBlockGamut),attrs.postBlockGamut&&converter.hooks.chain("postBlockGamut",scope.postBlockGamut),attrs.preSpanGamut&&converter.hooks.chain("preSpanGamut",scope.preSpanGamut),attrs.postSpanGamut&&converter.hooks.chain("postSpanGamut",scope.postSpanGamut),attrs.onPreviewRefresh&&editor.hooks.chain("onPreviewRefresh",scope.onPreviewRefresh),attrs.postBlockquoteCreation&&editor.hooks.chain("postBlockquoteCreation",scope.postBlockquoteCreation),attrs.insertImageDialog&&editor.hooks.set("insertImageDialog",scope.insertImageDialog),attrs.helpHandler&&(helpHandler=scope.helpHandler),attrs.customStrings&&(strings=scope.customStrings),element.addClass(prefix+"input"+postfix),editor=new Markdown.Editor(converter,postfix,prefix,helpHandler,strings),editor.run();var refresh=function(){$timeout(function(){editor.refreshPreview()},0)};scope.$watch("ngModel",function(){refresh()}),scope.$on("refreshMarkdown",function(event,message){message&&""!==message&&message!==prefix+postfix||refresh()})}}}}})}();